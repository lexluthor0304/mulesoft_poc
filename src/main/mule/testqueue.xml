<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns:salesforce-pub-sub="http://www.mulesoft.org/schema/mule/salesforce-pub-sub" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd http://www.mulesoft.org/schema/mule/http
  http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
  http://www.mulesoft.org/schema/mule/ee/core
  http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
  http://www.mulesoft.org/schema/mule/sqs
	http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/salesforce-pub-sub http://www.mulesoft.org/schema/mule/salesforce-pub-sub/current/mule-salesforce-pub-sub.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<sqs:config name="Amazon_SQS_Configuration" doc:name="Amazon SQS Configuration" doc:id="3a2a37e9-4eea-4409-b9db-ddc9d7734917" >
		<sqs:basic-connection testQueueArn="arn:aws:sqs:us-east-1:263584434972:bicsTest.fifo" accessKey="AKIAT2XW3JMOPIO62RU2" secretKey="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" />
	</sqs:config>
	<file:config name="File_Config" doc:name="File Config" doc:id="e0e1e169-440d-4f8c-b530-40b4a908d038" >
		<file:connection workingDir="${mule.home}/apps/${app.name}" />
	</file:config>
	<db:config name="Database_Config" doc:name="Database Config" doc:id="b5c213b6-70d2-419f-86d6-4621b2ae8603" >
		<db:my-sql-connection host="database-1.cxmxus7frfnz.us-east-1.rds.amazonaws.com" port="3306" user="bics" password="bics" database="bics" />
	</db:config>
	<flow name="sqs-send-messageFlow" >
		<http:listener doc:name="Listener" doc:id="3cea91f6-3eba-4f0b-99b2-041ad73ccd27" config-ref="HTTP_Listener_config" path="/testfifo"/>
		<file:read doc:name="Read" doc:id="4ee12748-bfc2-436b-9d48-8d4f8bff5383" path="${mule.home}/apps/${app.name}/CustomerUpdateList.csv" config-ref="File_Config"/>
		<foreach doc:name="For Each" doc:id="ea8b18c5-4104-4d45-8a17-22a8120f0942" >
			<ee:transform doc:name="Transform Message" doc:id="9e29e43e-c3a3-4f09-96f3-7e863654535d">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
    delaySeconds: 0,
    body: "correlationId" ++ correlationId,
    deduplicationId: payload[0].messageId,
    groupId: payload[0].groupId,
    messageAttributes: {
        "customerId": {
            "stringValue" :payload[0].customerId,
            "dataType" : "String"
        } as Object {
            class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
        },
        "customerName": {
            "stringValue" :payload[0].customerName,
            "dataType" : "String"
        } as Object {
            class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
        },
        "updateValue": {
            "stringValue" : payload[0].updateValue,
            "dataType" : "String"
        } as Object {
            class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
        }
    } as Object {
        class: "java.util.HashMap"
    }
} as Object {
    class: "org.mule.extension.sqs.api.model.Message"
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<sqs:send-message doc:name="Send message TestQueue" config-ref="Amazon_SQS_Configuration" queueUrl="https://sqs.us-east-1.amazonaws.com/263584434972/bicsTest.fifo" />
			<sqs:get-approximate-number-of-messages doc:name="Get approximate number of messages TestQueue" queueUrl="https://sqs.us-east-1.amazonaws.com/263584434972/bicsTest.fifo" config-ref="Amazon_SQS_Configuration" />
		</foreach>
	
</flow>
	<flow name="sqs-receive-message-flow" >
		<scheduler doc:name="Scheduler" doc:id="a5d4f9bc-2889-4c17-b518-41c6d3df383c" >
			<scheduling-strategy >
				<fixed-frequency frequency="10" timeUnit="SECONDS"/>
			</scheduling-strategy>
		</scheduler>
		<file:write doc:name="Write" doc:id="17f406fb-2401-41ce-910b-de5b19e15026" path="${mule.home}/apps/${app.name}/read002.csv" mode="CREATE_NEW">
			<file:content><![CDATA[#[""]]]></file:content>
		</file:write>
		<set-variable value="0" doc:name="Set Variable" doc:id="804caf4f-8d1b-4d62-801b-7b39438dfebe" variableName="counter"/>
		<try doc:name="Try" doc:id="fdca61dc-7abd-4946-8e0c-e815ee82fe15" transactionalAction="ALWAYS_BEGIN">
			<until-successful maxRetries="50" doc:name="Until Successful" doc:id="108fb9db-5333-48e9-ae22-dcadbb484ca3" millisBetweenRetries="1000">
				<sqs:read doc:name="Read" doc:id="a0f56ee2-2617-4fca-ba9a-82c2cec6b0ec" config-ref="Amazon_SQS_Configuration" maxNumberOfMessages="2" queueUrl="https://sqs.us-east-1.amazonaws.com/263584434972/bicsTest.fifo" />
				<ee:transform doc:name="Transform Message" doc:id="1c8290a1-c4d7-43fc-aec9-f08c240b74fc">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/csv
---
payload map ( payload01 , indexOfPayload01 ) -> {
	id: payload01.id default "",
	"Receipt handle": payload01.receiptHandle default ""
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
				<file:write doc:name="Write" doc:id="3e011c38-775e-4cfd-865d-c4e4f4d8a7cd" path="${mule.home}/apps/${app.name}/read002.csv" mode="APPEND" />
				<file:read doc:name="Read" doc:id="103f0473-5a51-432c-a294-ce908dd71018" path="${mule.home}/apps/${app.name}/read002.csv" config-ref="File_Config" />
				<ee:transform doc:name="Transform Message" doc:id="a8a8bf97-892d-4e48-ae33-824b436a042e">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
							</ee:message>
						</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="a46a792a-93a3-4285-ac77-52094d2570b1" message="#[sizeOf(payload)]" />
				<choice doc:name="Choice" doc:id="83eac66b-0fff-427d-a3c6-139e0a859bd8" >
					<when expression="#[sizeOf(payload)&lt;20]">
						<raise-error doc:name="Raise error" doc:id="8bcc17e2-0b9f-4b37-aeb4-6e100baa6258" type="APP:HANDLE"/>
					</when>
				</choice>
		</until-successful>
			<flow-ref doc:name="Flow Reference" doc:id="b5c30bad-f6a2-42d8-9875-37610c6e0970" name="subFlow1"/>
			<flow-ref doc:name="Flow Reference" doc:id="4fba081c-de7a-4850-bbec-4b1802179548" name="subFlow2"/>
			<logger level="INFO" doc:name="Logger" doc:id="4c902073-4c8a-4e62-89c9-8e4bef612dd8" />
		</try>
	</flow>
	<sub-flow name="subFlow1" doc:id="3905d0bb-bd69-4acd-9e38-d15c7010ff76">
		<file:read doc:name="Read" doc:id="49900441-9383-452b-8612-f47881106782" path="${mule.home}/apps/${app.name}/read002.csv" />
		<ee:transform doc:name="Transform Message" doc:id="039ee54e-77d6-480a-b72c-bd7864983384">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
var filteredPayload = payload filter (item, index) -> item.id != "id"
---
filteredPayload map (payload01, indexOfPayload01) -> {
	customerId: payload01.customerId default "",
	updateValue: payload01.updateValue default ""
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="01a319a9-da67-465b-966e-3f9926668f07" collection="#[payload]">
			<db:insert doc:name="Insert" doc:id="13070f59-bc75-422c-a242-f64daa3b80ec" config-ref="Database_Config" transactionalAction="ALWAYS_JOIN">
			<db:sql><![CDATA[insert into customes(id,name)values(:id,:name)]]></db:sql>
				<db:input-parameters><![CDATA[#[{
        'id' : payload.customerId,
        'name' : payload.updateValue
}]]]></db:input-parameters>
		</db:insert>
		</foreach>
	</sub-flow>
	<sub-flow name="subFlow2" doc:id="462213f8-3398-4079-b32a-85d75d810c2b" >
		<file:read doc:name="Read" doc:id="819887e8-5ce6-4f48-89c4-478b03390554" path="${mule.home}/apps/${app.name}/read002.csv" />
		<ee:transform doc:name="Transform Message" doc:id="a2c5f276-a378-4a7d-96f6-a282e47995ce" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
var filteredPayload = payload filter (item, index) -> item.id != "id"
---
filteredPayload map (payload01, indexOfPayload01) -> {
	id: payload01.id default "",
	"ReceiptHandle": payload01."Receipt handle" default ""
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="1d993328-eecf-4bc0-bff8-9171f059548e" collection="#[payload]">
			<sqs:delete-message doc:name="Delete message" doc:id="3ce9bb98-9aaa-4e82-ac8d-757434144a8c" config-ref="Amazon_SQS_Configuration" receiptHandle="#[payload.ReceiptHandle]" queueUrl="https://sqs.us-east-1.amazonaws.com/263584434972/bicsTest.fifo"/>
		</foreach>
		<logger level="INFO" doc:name="Logger1" doc:id="a670ee43-7736-4d98-acf4-c44e134b120b" />
	</sub-flow>

</mule>
